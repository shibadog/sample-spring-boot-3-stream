# logging
logging:
  pattern:
    console: "%clr(%d{${LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd'T'HH:mm:ss.SSSXXX}}){faint} %clr(${LOG_LEVEL_PATTERN:-%5p}) [%X{traceId}-%X{spanId}] %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}"

# actuator
management:
  health:
    rabbit:
      enabled: true
    binders:
      enabled: true

  endpoints:
    web:
      exposure:
        include:
        - "*"

  tracing:
    enabled: true
    propagation: 
      type: b3
    sampling:
      probability: 1.0

  zipkin:
    tracing:
      connect-timeout: 2s
      read-timeout: 5s
      endpoint: http://localhost:9411/api/v2/spans

# spring
spring:
  application:
    name: @project.name@

  rabbitmq:
    host: localhost
    port: 5672
    username: admin
    password: admin
    address-shuffle-mode: RANDOM
    addresses: localhost:5673,localhost:5674,localhost:5675

  cloud:
    function:
      definition: consume;functionRouter # functionRouterを使ってConsumeBeanをroutingするのであれば、該当functionRouterを明示。
      routing-expression: "headers['path'] == '/service/hoge' ? 'routingConsumeHoge' : headers['path'] == '/service/fuga' ? 'routingConsumeFuga' : null"
      # defaultのfunctionRouterに対するrouting条件はここに記載

    stream:
      function:

        bindings:
          consume-in-0: input # ここがfunctionにラベルを付けるところ
          # bean定義したfunctionalを返すBeanのメソッド名+"-in-0"
          functionRouter-in-0: input2 # defaultのfunctionRouterを使う場合はこのような書き方。
          # FunctionRouterを返す `functionRouter` という名前ではないBeanを独自に作成することができる。

      bindings:
        input: # ラベルで指定
          group: service
          destination: listener
          content-type: application/json
          consumer:
            concurrency: 10 # consumer thread count
            max-attempts: 3 # retry count
        input2: 
          group: service
          destination: listener2
          content-type: application/json
          consumer:
            concurrency: 10 # consumer thread count
            max-attempts: 3 # retry count

      rabbit:
        bindings:
          consume-in-0: # ラベルで紐づけはできないらしい
            consumer:
              auto-bind-dlq: true # lint errorなるけど多分効いている
              # 自動で、 `{destination}.{group}.dlq` というキューに入る
              # exchangeはDLXが使われるらしい。
